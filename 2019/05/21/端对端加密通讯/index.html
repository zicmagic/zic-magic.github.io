<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="zic_magic" />










<meta name="description" content="近期对WhatsApp做了破解，但是做到了最后发现是端对端的聊天，导致方案预先设计的流程无法实现，所以就对次进行进一步的了解与学习，本文算是一个学习笔记，仅供大家学习。学习的内容大致分为二个大部分：1、术语解析 2、WhatsAPP的通讯流程。（可以先看第二部分，有部分不了解的可以再回头看第一部分）都是围绕着Signal protocol 进行梳理和解释，Signal protocol是真正的端到">
<meta name="keywords" content="iOS">
<meta property="og:type" content="article">
<meta property="og:title" content="端对端加密通讯协议（WhatsAPP）">
<meta property="og:url" content="http://yoursite.com/2019/05/21/端对端加密通讯/index.html">
<meta property="og:site_name" content="Zic_Magic">
<meta property="og:description" content="近期对WhatsApp做了破解，但是做到了最后发现是端对端的聊天，导致方案预先设计的流程无法实现，所以就对次进行进一步的了解与学习，本文算是一个学习笔记，仅供大家学习。学习的内容大致分为二个大部分：1、术语解析 2、WhatsAPP的通讯流程。（可以先看第二部分，有部分不了解的可以再回头看第一部分）都是围绕着Signal protocol 进行梳理和解释，Signal protocol是真正的端到">
<meta property="og:locale" content="default">
<meta property="og:image" content="http://yoursite.com/2019/05/21/端对端加密通讯/image1.png">
<meta property="og:updated_time" content="2019-05-22T06:39:27.356Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="端对端加密通讯协议（WhatsAPP）">
<meta name="twitter:description" content="近期对WhatsApp做了破解，但是做到了最后发现是端对端的聊天，导致方案预先设计的流程无法实现，所以就对次进行进一步的了解与学习，本文算是一个学习笔记，仅供大家学习。学习的内容大致分为二个大部分：1、术语解析 2、WhatsAPP的通讯流程。（可以先看第二部分，有部分不了解的可以再回头看第一部分）都是围绕着Signal protocol 进行梳理和解释，Signal protocol是真正的端到">
<meta name="twitter:image" content="http://yoursite.com/2019/05/21/端对端加密通讯/image1.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2019/05/21/端对端加密通讯/"/>





  <title>端对端加密通讯协议（WhatsAPP） | Zic_Magic</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Zic_Magic</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/05/21/端对端加密通讯/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zic_magic">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zic_Magic">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">端对端加密通讯协议（WhatsAPP）</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-05-21T14:00:16+08:00">
                2019-05-21
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>近期对WhatsApp做了破解，但是做到了最后发现是端对端的聊天，导致方案预先设计的流程无法实现，所以就对次进行进一步的了解与学习，本文算是一个学习笔记，仅供大家学习。学习的内容大致分为二个大部分：1、术语解析 2、WhatsAPP的通讯流程。（可以先看第二部分，有部分不了解的可以再回头看第一部分）都是围绕着Signal protocol 进行梳理和解释，Signal protocol是真正的端到端的通讯加密协议，号称是世界上最安全的通讯协议，任何第三方包括服务器都无法查看通讯内容.</p>
<h2 id="术语解析"><a href="#术语解析" class="headerlink" title="术语解析"></a>术语解析</h2><p>要了解整个的加密通讯协议，首先就是要了解一些密钥交换和加密方法，除了DH密钥交换会稍微的讲一下是如何得到，其他的只做流程上的介绍不深入。</p>
<h3 id="DH密钥交换-Diffie–Hellman-key-exchange"><a href="#DH密钥交换-Diffie–Hellman-key-exchange" class="headerlink" title="DH密钥交换 (Diffie–Hellman key exchange)"></a>DH密钥交换 (Diffie–Hellman key exchange)</h3><p>DH密钥交换是1976年由Diffie和Hellman共同发明的一种算法。使用这种算法，通信双方仅通过交换一些可以公开的信息就能够生成出共享的密码数字，而这一密码数字就可以被用作对称密码的密钥。DH只是一种密钥交换的方法而不是密钥的加密算法。</p>
<p>虽然这种方法的名字叫“密钥交换”，但实际上双方并没有真正交换密钥，而是通过计算生成出一个相同的共享密钥。因此，这种方法也称DH密钥协商。</p>
<h4 id="交换的流程"><a href="#交换的流程" class="headerlink" title="交换的流程"></a>交换的流程</h4><p>流程图参考网上的一个资源，感觉是画的最好的一个。</p>
<p><img src="/2019/05/21/端对端加密通讯/image1.png" alt="图片1"></p>
<p>以下是对图示内容的讲解</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">1 Alice向Bob发送两个质数P和G</span><br><span class="line"></span><br><span class="line">P必须是一个非常大的质数，而G则是一个和P相关的数，称为生成元。G可以是一个较小的数字。</span><br><span class="line"></span><br><span class="line">P和G不需要保密，被窃听者获取了也没关系。</span><br><span class="line"></span><br><span class="line">P和G可以由Alice和Bob中的任意一方生成。</span><br><span class="line"></span><br><span class="line">2 Alice生成一个随机数A</span><br><span class="line"></span><br><span class="line">A是一个1~P-2之间的整数。这个数是一个只有Alice知道的秘密数字，没有必要告诉Bob，也不能让窃听者知道。</span><br><span class="line"></span><br><span class="line">3 Bob生成一个随机数B</span><br><span class="line"></span><br><span class="line">B是一个1~P-2之间的整数。这个数是一个只有Bob知道的秘密数字，没有必要高数Alice，也不能让窃听者知道。</span><br><span class="line"></span><br><span class="line">4 Alice将 G的A次方 mod P 这个数发送给Bob</span><br><span class="line"></span><br><span class="line">这个数让窃听者知道也没关系。</span><br><span class="line"></span><br><span class="line">5 Bob 将 G的B次方 mod P 这个数发送给Alice</span><br><span class="line"></span><br><span class="line">这个数让窃听者知道也没关系。</span><br><span class="line"></span><br><span class="line">6 Alice用Bob发过来的数计算A次方并求 mod P</span><br><span class="line"></span><br><span class="line">这个数就是共享密钥。</span><br><span class="line"></span><br><span class="line">Alice计算的密钥 = (G^B mod(P))^A mod(P)</span><br><span class="line">		      = G^(A*B) mod(P)</span><br><span class="line">(百度了好久 用markdown编辑数学公式都失败了 有知道的大佬可以指点我一下)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">上面将mod P的“G的B次方的A次方” 改写成了“G的A*B次方”</span><br><span class="line"></span><br><span class="line">7 Bob用Alice发过来的数计算B次方并求 mod P</span><br><span class="line"></span><br><span class="line">Bob计算的密钥 = (G^A mod(P))^B mod(P)</span><br><span class="line">		      = G^(A*B) mod(P)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">于是Alice和Bob就计算出相等的共享密钥了。</span><br></pre></td></tr></table></figure>
<h3 id="ECDH"><a href="#ECDH" class="headerlink" title="ECDH"></a>ECDH</h3><p>ECDH是EC是”elliptic curves”的意思，DH是”Diffie-Hellman”的意思，就是ECC算法和DH的结合使用.ECC是建立在基于椭圆曲线的离散对数问题上的密码体制，给定椭圆曲线上的一个点P，一个整数k，求解Q=kP很容易；给定一个点P、Q，知道Q=kP，求整数k确是一个难题。ECDH即建立在此数学难题之上。密钥磋商过程:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">假设密钥交换双方为Alice、Bob，其有共享曲线参数（椭圆曲线E、阶N、基点G（ji公钥））。</span><br><span class="line"></span><br><span class="line">1 Alice生成随机整数a，计算A=a*G。 #生成Alice公钥</span><br><span class="line"></span><br><span class="line">2 Bob生成随机整数b，计算B=b*G。 #生产Bob公钥</span><br><span class="line"></span><br><span class="line">3 Alice将A传递给Bob。A的传递可以公开，即攻击者可以获取A</span><br><span class="line">   </span><br><span class="line">4 Bob将B传递给Alice。同理，B的传递可以公开</span><br><span class="line"></span><br><span class="line">5 Bob收到Alice传递的A，计算Q =b*A#Bob通过自己的私钥和Alice的公钥得到对称密钥Q6) Alice收到Bob传递的B，计算Q&apos;=a*B#Alice通过自己的私钥和Bob的公钥得到对称密钥Q&apos;</span><br><span class="line"></span><br><span class="line">Alice、Bob双方即得Q=b*A=b*(a*G)=(b*a)*G=(a*b)*G=a*(b*G)=a*B=Q&apos; (交换律和结合律)，即双方得到一致的密钥Q</span><br><span class="line"></span><br><span class="line">由于椭圆曲线的离散对数问题是难题，所以攻击者不可以通过A、G计算出a（这里不对ecc算法做具体的研究可以自行了解，是个比较复杂的数据问题）</span><br></pre></td></tr></table></figure>
<h3 id="X3DH-——DH协议的3倍扩展版"><a href="#X3DH-——DH协议的3倍扩展版" class="headerlink" title="X3DH ——DH协议的3倍扩展版"></a>X3DH ——DH协议的3倍扩展版</h3><p>whatsAPP 采用的是X3DH协议，更确切的说，是X3ECDH协议。</p>
<p>X3DH协议基于DH协议，但是引入更多的公钥参数以提高安全性。在X3DH协议下，有3个角色：</p>
<p>1、会话发起者，本例我们假设是Alice；</p>
<p>2、会话接收者，本例我们假设是Bob；</p>
<p>3、服务器: 用于存储所有用户的各种公钥。</p>
<p>在X3DH协议里，也许是为了提高安全性，每个人都要创建3种密钥对，分别如下：</p>
<p>1、身份密钥对（Identity Key Pair） —— 一个长期的符合DH协议的密钥对,用户注册时创建，与用户身份绑定；</p>
<p>2、已签名的预共享密钥（Signed Pre Key） ——一个中期的符合DH协议的密钥对，用户注册时创建，由身份密钥签名，并定期进行轮换，此密钥可能是为了保护身份密钥不被泄露；</p>
<p>3、一次性预共享密钥（One-Time Pre Keys） —— 一次性使用的 Curve25519 密钥对队列，安装时生成，不足时补充。</p>
<p>所有人都要将这3种密钥对的公钥上传到服务器上，以便其他人发起会话时使用。假如Alice要给Bob发送消息，首先要和Bob确定消息密钥，流程大致如下</p>
<p>1、Alice 要创建一个临时密钥对（ephemeral key），我们设成EPK-A，此密钥对是为了后面棘轮算法准备，在此处作用不大；</p>
<p>2) Alice从服务器获取Bob的三种密钥对的公钥：身份密钥对IPK-B；已签名的预共享密钥SPK-B；一次性预共享密钥OPK-B</p>
<p>3) Alice开始使用DH协议计算协商密钥，要引入参数包括：自己创建的2个密钥对的私钥，以及Bob的三个公钥。然后用类似排列组合的方式，将自己的私钥与对方的公钥分别带入DH算法计算，</p>
<p>DH1 = DH(IPK-A, SPK-B)</p>
<p>DH2 = DH(EPK-A, IPK-B)</p>
<p>DH3= DH(EPK-A, SPK-B)</p>
<p>DH4 = DH(IPK-A, OPK-B)</p>
<h2 id="WhatsAPP-通讯流程"><a href="#WhatsAPP-通讯流程" class="headerlink" title="WhatsAPP 通讯流程"></a>WhatsAPP 通讯流程</h2><h3 id="客户端注册"><a href="#客户端注册" class="headerlink" title="客户端注册"></a>客户端注册</h3><p>在注册时，WhatsApp 客户端将身份公钥（public Identity Key）、已签名的预共享公钥（public Signed Pre Key）和一批一次性预共享公钥（One-Time Pre Keys）发送给服务器。WhatsApp 服务器存储用户身份相关的公钥。WhatsApp 服务器无法访问任何客户端的私钥。</p>
<h3 id="会话初始化设置"><a href="#会话初始化设置" class="headerlink" title="会话初始化设置"></a>会话初始化设置</h3><p>要与另一个 WhatsApp 用户通信，WhatsApp 客户端需要先建立一个加密会话。加密会话一旦被创建，客户端就不需要再重复创建会话，除非会话失效（例如重新安装应用或更换设备）。</p>
<p>建立会话：</p>
<p>1、会话发起人为接收人申请身份公钥（public Identity Key）、已签名的预共享公钥（public Signed Pre Key）和一个一次性预共享密钥（One-Time Pre Key）。</p>
<p>2、服务器返回所请求的公钥。一次性预共享密钥（One-Time Pre Key）仅使用一次，因此请求完成后将从服务器删除。如果一次性预共享密钥（One-Time Pre Key）被用完且尚未补充，则返回空。</p>
<p>3、发起人将接收人的身份密钥（Identity Key）存为 Irecipient，将已签名的预共享密钥（Signed Pre Key）存为 Srecipient，将一次性预共享密钥（One-Time Pre Key）存为 Orecipient。</p>
<p>4、发起者生成一个临时的 Curve25519 密钥对 —— Einitiator</p>
<p>5、发起者加载自己的身份密钥（Identity Key）作为 Iinitiator</p>
<p>6、发起者计算主密钥 master_secret = ECDH ( Iinitiator, Srecipient ) || ECDH ( Einitiator, Irecipient ) || ECDH ( Einitiator, Srecipient )  || ECDH ( Einitiator, Orecipient ) 。如果没有一次性预共享密钥（One-Time Pre Key），最终 ECDH 将被忽略。</p>
<p>7、发起者使用 HKDF 算法从 master_secret 创建一个根密钥（Root Key）和链密钥（Chain Keys）。</p>
<h3 id="接收会话设置"><a href="#接收会话设置" class="headerlink" title="接收会话设置"></a>接收会话设置</h3><p>在建立长期加密会话后，发起人可以立即向接收人发送消息，即使接收人处理离线状态。在接收方响应之前，发起方所有的消息都会包含创建会话所需的信息（在消息的 header 里）。其中包括发起人的 Einitiator 和 Iinitiator 。当接收方收到包含会话设置的消息时：</p>
<p>1、接收人使用自己的私钥和消息 header 里的公钥来计算相应的主密钥</p>
<p>2、接收人删除发起人使用的一次性预共享密钥（One-Time Pre Key）</p>
<p>3、发起人使用 HKDF 算法从主密钥派生出相应的根密钥（Root Key）和链密钥（Chain Keys）</p>
<h3 id="交换消息"><a href="#交换消息" class="headerlink" title="交换消息"></a>交换消息</h3><p>一旦建立了会话，通过 AES256 消息密钥加密（CbC 模式）和 HMAC-SHA256 验证来保护客户端交换消息。<br>消息密钥是短暂的且在每次发送消息后都会变化，使得用于加密消息的消息密钥不能从已发送或已接收后的会话状态中重建。<br>消息密钥在发送消息时对发送人的链密钥（Chain Key）进行向前的“棘轮（ratchets）”派生而来。此外，每次消息巡回都执行一个新的 ECDH 协议以创建一个新的链密钥（Chain Key）。通过组合即时 “哈希棘轮（hash ratchet）” 和巡回 “DH 棘轮（DH ratchet）” 提供前向安全。</p>
<h3 id="通过链密钥（Chain-Key）计算消息密钥（Message-Key）"><a href="#通过链密钥（Chain-Key）计算消息密钥（Message-Key）" class="headerlink" title="通过链密钥（Chain Key）计算消息密钥（Message Key）"></a>通过链密钥（Chain Key）计算消息密钥（Message Key）</h3><p>消息发送者每次需要新的消息密钥时，计算如下：</p>
<p>1、消息密钥（Message Key）= HMAC-SHA256(Chain Key, 0x01)</p>
<p>2、链密钥（Chain Key）随后更新为： 链密钥（Chain Key） = HMAC-SHA256(Chain Key, 0x02)</p>
<p>这样形成向前“棘轮（ratchets）”链密钥（Chain Key），这也意味不能使用存储的消息密钥推导出当前或过去的链密钥（Chain Key）值。</p>
<h3 id="通过根密钥（Root-Key）计算链密钥（Chain-Key）"><a href="#通过根密钥（Root-Key）计算链密钥（Chain-Key）" class="headerlink" title="通过根密钥（Root Key）计算链密钥（Chain Key）"></a>通过根密钥（Root Key）计算链密钥（Chain Key）</h3><p>每一条发送的消息都附带一个短期的 Curve25519 公钥。一旦收到响应，新的链密钥（Chain Key）计算如下：</p>
<p>1、ephemeral_secret = ECDH(Ephemeralsender, Ephemeralrecipient)</p>
<p>2、链密钥（Chain Key），根密钥（Root Key）= HKDF(Root Key, ephemeral_secret)</p>
<p>一个链密钥只能给一个用户发消息，所以消息密钥不能被重用。由于消息密钥和链密钥（Chain Keys）的计算方式，消息可能会延迟、乱序或完全丢失而不会有问题。</p>
<h3 id="传输媒体和附件"><a href="#传输媒体和附件" class="headerlink" title="传输媒体和附件"></a>传输媒体和附件</h3><p>任何类型的大附件（视频，音频，图像或文件）也都是端对端加密的：</p>
<p>1、发件人（发消息的 WhatsApp 用户）生成一个 32 字节的 AES256 临时密钥和一个 32 字节HMAC-SHA256 临时密钥。</p>
<p>2、发件人通过 AES256 密钥（CBC 模式）和随机 IV 给附件加密，然后附加使用 HMAC-SHA256 密文的 MAC。</p>
<p>3、发件人将加密的附件以上传到服务器以二进制存储。</p>
<p>4、发件人给收件人发送一个包含加密密钥、HMAC 密钥、加密二进制的 SHA256 哈希值和指向二进制存储的指针的加密消息</p>
<p>5、收件人解密消息，从服务器检索加密的二进制数据，验证 AES256 哈希，验证 MAC并解密为明文</p>
<h3 id="群组消息"><a href="#群组消息" class="headerlink" title="群组消息"></a>群组消息</h3><p>传统未加密的聊天应用通常对群组消息使用“服务器扇出（server-side fan-out）”来发群组消息。当一个用户向群组发消息时，服务器将消息分发给每一个群组成员。</p>
<p>而“客户端扇出（client-side fan-out）”是客户端将消息发给每一个群组成员。</p>
<p>WhatsApp 的群组消息基于上面列出的成对加密会话构建，以便高效实现大量群组消息通过服务器扇出（server-side fan-out）。这是通过 Signal 传输协议（Signal Messaging Protocol）的 “发送者密钥（Sender Keys）”来完成的。<br>WhatsApp 群组成员第一次发消息到群组：</p>
<p>1、发送人生成一个随机 32 字节的链密钥（Chain Key）。</p>
<p>2、发送人生成一个随机 Curve25519 签名密钥对。</p>
<p>3、发送人将 32 位链密钥（Chain Key）和签名密钥中的公钥组合成消息发送人密钥（Sender Key）。</p>
<p>4、发件人用成对传输协议为每个群组成员单独加密发送人密钥（Sender Keys）。</p>
<p>所有后续发给该群组的消息：</p>
<p>1、发送人从链密钥（Chain Key）中获取消息密钥（Message Key）并更新链密钥（Chain Key）</p>
<p>2、发送人在 CbC 模式下使用 AES256 加密消息</p>
<p>3、发送人使用签名密钥（Signature Key）签名密文</p>
<p>4、发送人将单个密文消息发给服务器，服务器将消息分发给所有群组成员</p>
<p>消息发送人链密钥（Chain Key）的“哈希棘轮（hash ratchet）”提供向前安全。当群组成员离开时时，所有剩下的群组成员都清除发送人密钥（Sender Key）并重新生成。</p>
<h3 id="通话设置"><a href="#通话设置" class="headerlink" title="通话设置"></a>通话设置</h3><p>WhatsApp 语音和视频通话也是端对端加密。当 WhatsApp 用户发起语音或视频通话时：</p>
<p>1、发起人与接收人建立加密会话（如果还没有建立过）</p>
<p>2、发起人生成一个随机 32 字节的安全实时传输协议（SRTP） 主密钥（master secret）</p>
<p>3、发起人向接收人发送一个包含安全实时传输协议（SRTP）主密钥的加密消息用于发通话信号</p>
<p>4、如果应答了呼叫，跟着发起安全实时传输协议（SRTP）呼叫</p>
<h3 id="状态"><a href="#状态" class="headerlink" title="状态"></a>状态</h3><p>WhatsApp 状态加密方式和群组消息非常相似。给指定的一组接收人第一次发状态遵循向群组第一次发消息相同的步骤。类似地，给同一组接收人发送后续状态也遵循发群组消息相同的步骤。当状态发送人更改状态隐私设置或从地址簿种删除号码来删除接收人时，状态发送人会清除发送人密钥（Sender Key）并重新生成。</p>
<h3 id="验证密钥"><a href="#验证密钥" class="headerlink" title="验证密钥"></a>验证密钥</h3><p>WhatsApp 用户还可以验证与之通信用户的密钥，以便他们能够确认未授权的第三方（或 WhatsApp）未发起中间人攻击。通过扫描二维码或通过比较 60 位数字来完成。<br>二维码包括：</p>
<p>1、版本号</p>
<p>2、双方的用户身份</p>
<p>3、双方完整的 32 字节身份公钥</p>
<p>当用户扫描对方的二维码时，将比较这些密钥以确保二维码中的身份密钥与服务器检索到的相匹配。<br>通过拼接两个用户身份密钥的 30 位数字指纹来计算 60 位数字号码。计算 30 位数字指纹步骤：</p>
<p>1、重复 SHA-512 哈希身份公钥和用户标识符 5200 次</p>
<p>2、获取最后输出哈希的前 30 个字节</p>
<p>3、将 30 个字节分成 6 组每组 5 字节的数据块</p>
<p>4、通过解析每组 5 字节数据块为 big-endian 无符号整形并且取模 10 万次转换为 5 个数字</p>
<p>5、把六组每组 5 个数字连接成 30 位数字</p>
<h3 id="传输安全"><a href="#传输安全" class="headerlink" title="传输安全"></a>传输安全</h3><p>WhatsApp 客户端和服务器之间所有通信都在单独的加密通道内分层。在 Windows Phone、iPhone 和 Android 上，这些端对端加密客户端可以使用噪音管道（Noise Pipes），使用噪声协议框架（Noise Protocol Framework）中的 Curve25519、AES-GCM 和 SHA256 实现长期运行的交互连接。</p>
<p>这为客户端提供了一些不错的属性：</p>
<p>1、极快的轻量级连接设置和恢复</p>
<p>2、加密隐藏元数据防止未授权的网络监听。没有透露连接用户身份相关的信息。</p>
<p>3、服务器上不存储客户端的安全认证信息。客户端使用 Curve25519 密钥进行身份验证，因此服务器仅保存客户端认证公钥（public authentication key）。如果服务器的用户数据库被入侵，也不会泄露个人认证凭证。</p>
<h3 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h3><p>WhatsApp 用户之间的消息受到端对端加密协议的保护，因此第三方和 WhatsApp 都无法获知消息内容，消息只能由接收人解密。所有 WhatsApp 消息（包括聊天、群聊、图片、视频、语音消息和文件）和 WhatsApp 通话都受到端对端加密的保护。<br>WhatsApp 服务器无法访问 WhatsApp 用户的私钥，并且 WhatsApp 用户可以选择验证密钥以确保其通讯完整。</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/10/26/RAC的使用/" rel="next" title="RAC的使用与源码分析">
                <i class="fa fa-chevron-left"></i> RAC的使用与源码分析
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">zic_magic</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">7</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            

            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#术语解析"><span class="nav-number">1.</span> <span class="nav-text">术语解析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#DH密钥交换-Diffie–Hellman-key-exchange"><span class="nav-number">1.1.</span> <span class="nav-text">DH密钥交换 (Diffie–Hellman key exchange)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#交换的流程"><span class="nav-number">1.1.1.</span> <span class="nav-text">交换的流程</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ECDH"><span class="nav-number">1.2.</span> <span class="nav-text">ECDH</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#X3DH-——DH协议的3倍扩展版"><span class="nav-number">1.3.</span> <span class="nav-text">X3DH ——DH协议的3倍扩展版</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#WhatsAPP-通讯流程"><span class="nav-number">2.</span> <span class="nav-text">WhatsAPP 通讯流程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#客户端注册"><span class="nav-number">2.1.</span> <span class="nav-text">客户端注册</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#会话初始化设置"><span class="nav-number">2.2.</span> <span class="nav-text">会话初始化设置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#接收会话设置"><span class="nav-number">2.3.</span> <span class="nav-text">接收会话设置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#交换消息"><span class="nav-number">2.4.</span> <span class="nav-text">交换消息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#通过链密钥（Chain-Key）计算消息密钥（Message-Key）"><span class="nav-number">2.5.</span> <span class="nav-text">通过链密钥（Chain Key）计算消息密钥（Message Key）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#通过根密钥（Root-Key）计算链密钥（Chain-Key）"><span class="nav-number">2.6.</span> <span class="nav-text">通过根密钥（Root Key）计算链密钥（Chain Key）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#传输媒体和附件"><span class="nav-number">2.7.</span> <span class="nav-text">传输媒体和附件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#群组消息"><span class="nav-number">2.8.</span> <span class="nav-text">群组消息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#通话设置"><span class="nav-number">2.9.</span> <span class="nav-text">通话设置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#状态"><span class="nav-number">2.10.</span> <span class="nav-text">状态</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#验证密钥"><span class="nav-number">2.11.</span> <span class="nav-text">验证密钥</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#传输安全"><span class="nav-number">2.12.</span> <span class="nav-text">传输安全</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#补充"><span class="nav-number">2.13.</span> <span class="nav-text">补充</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">zic_magic</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
